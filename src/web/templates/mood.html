{% extends "base.html" %}
{% block title %}Mood - Minion{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}
<h2>Mood Tracker</h2>

{% if stats and stats.count > 0 %}
<div class="grid-stats">
    <div class="stat-card">
        <div class="value">{{ stats.avg }}</div>
        <div class="label">Average ({{ stats.count }} days)</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ stats.trend|title }}</div>
        <div class="label">Trend</div>
    </div>
    {% if stats.best_day %}
    <div class="stat-card">
        <div class="value">{{ stats.best_score }}/5</div>
        <div class="label">Best ({{ stats.best_day }})</div>
    </div>
    {% endif %}
</div>
{% endif %}

{% if logs %}
<div style="margin-bottom:2rem;height:300px">
    <canvas id="moodChart"></canvas>
</div>
{% endif %}

<h4>Log Today</h4>
<form class="inline-form" hx-post="/app/mood" hx-target="#mood-list" hx-swap="afterbegin" hx-on::after-request="this.reset();" style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 0.75rem;">
        {% for score, emoji in [(1, '&#128542;'), (2, '&#128533;'), (3, '&#128528;'), (4, '&#128578;'), (5, '&#128516;')] %}
        <label style="cursor: pointer; font-size: 1.5rem; text-align: center;">
            <input type="radio" name="score" value="{{ score }}" style="display: block; margin: 0 auto;" {% if score == 3 %}checked{% endif %}>
            {{ emoji }}
        </label>
        {% endfor %}
    </div>
    <input type="text" name="note" placeholder="Note (optional)">
    <button type="submit">Log</button>
</form>

<h4>History</h4>
<div id="mood-list">
{% for m in logs %}
{% include "partials/mood_row.html" %}
{% else %}
<p class="empty-state">No mood logs yet.</p>
{% endfor %}
</div>

{% if logs %}
<script>
(function() {
    const labels = [{% for m in logs|reverse %}"{{ m.date.strftime('%b %d') }}"{% if not loop.last %},{% endif %}{% endfor %}];
    const data = [{% for m in logs|reverse %}{{ m.score }}{% if not loop.last %},{% endif %}{% endfor %}];

    new Chart(document.getElementById('moodChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                borderColor: 'rgb(129,140,248)',
                backgroundColor: 'rgba(129,140,248,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 0,
                    max: 5,
                    ticks: { stepSize: 1, color: 'rgba(255,255,255,0.5)' },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                },
                x: {
                    ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45 },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                }
            }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
