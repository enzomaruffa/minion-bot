#!/usr/bin/env sh
# bd-shim v2
# bd-hooks-version: 0.55.4
#
# bd (beads) pre-commit hook — thin shim
#
# Delegates to 'bd hook pre-commit' which contains the actual hook logic.
# This pattern ensures hook behavior is always in sync with the installed
# bd version — no manual updates needed.
#
# The 'bd hook' command supports:
# - Per-worktree export state tracking
# - Dolt in-process export (no lock deadlocks)
# - Sync-branch routing
# - Hook chaining configuration

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    echo "Warning: bd command not found in PATH, skipping pre-commit hook" >&2
    echo "  Install bd: brew install beads" >&2
    echo "  Or add bd to your PATH" >&2
    exit 0
fi

# Run bd hook first
bd hook pre-commit "$@"
BD_STATUS=$?

# Run ruff + ty checks on staged Python files
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM -- '*.py')
if [ -n "$STAGED_PY" ]; then
    echo "Running ruff check..."
    uv run ruff check src/ || exit 1
    echo "Running ruff format check..."
    uv run ruff format --check src/ || exit 1
    echo "Running ty type check..."
    uv run ty check src/ || exit 1
fi

exit $BD_STATUS
