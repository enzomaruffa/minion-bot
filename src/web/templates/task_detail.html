{% extends "base.html" %}
{% block title %}Task #{{ task.id }} - Minion{% endblock %}
{% block content %}
<p><a href="/app/tasks">&larr; Back to tasks</a></p>

<div style="display: flex; justify-content: space-between; align-items: start;">
    <h2>
        {% if task.project %}{{ task.project.emoji }} {% endif %}
        {{ task.title }}
        {% if task.recurrence_rule %} &#128260;{% endif %}
    </h2>
    <div style="display: flex; gap: 0.5rem;">
        <span class="badge badge-{{ task.status.value }}">{{ task.status.value }}</span>
        <span class="badge badge-{{ task.priority.value }}">{{ task.priority.value }}</span>
    </div>
</div>

{% if task.description %}
<article style="padding: 0.75rem 1rem;">
    <p>{{ task.description }}</p>
</article>
{% endif %}

<div class="grid">
    <div>
        <strong>Due:</strong> {{ task.due_date.strftime('%b %d, %Y %H:%M') if task.due_date else 'No due date' }}
    </div>
    <div>
        <strong>Project:</strong> {{ task.user_project.emoji + ' ' + task.user_project.name if task.user_project else 'None' }}
    </div>
    <div>
        <strong>Contact:</strong> {{ task.contact.name if task.contact else 'None' }}
    </div>
</div>

<hr>

<h4>Quick Actions</h4>
<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    {% if task.status.value != 'done' %}
    <form hx-patch="/app/tasks/{{ task.id }}" hx-target="body" hx-vals='{"status": "done"}'>
        <button type="submit" class="outline">Complete</button>
    </form>
    {% endif %}
    {% if task.status.value == 'todo' %}
    <form hx-patch="/app/tasks/{{ task.id }}" hx-target="body" hx-vals='{"status": "in_progress"}'>
        <button type="submit" class="outline">Start</button>
    </form>
    {% endif %}
    <form hx-delete="/app/tasks/{{ task.id }}" hx-target="body" hx-confirm="Delete this task?">
        <button type="submit" class="outline secondary">Delete</button>
    </form>
</div>

{% if subtasks %}
<hr>
<h4>Subtasks</h4>
{% for s in subtasks %}
<div class="task-row">
    <span class="task-id">#{{ s.id }}</span>
    <a href="/app/tasks/{{ s.id }}" class="task-title" style="text-decoration: none; color: inherit;">
        {% if s.status.value == 'done' %}<s>{{ s.title }}</s>{% else %}{{ s.title }}{% endif %}
    </a>
    <span class="badge badge-{{ s.status.value }}">{{ s.status.value }}</span>
</div>
{% endfor %}
{% endif %}

<hr>
<details>
    <summary>Edit Task</summary>
    <form hx-patch="/app/tasks/{{ task.id }}" hx-target="body">
        <label for="edit-title">Title</label>
        <input type="text" name="title" id="edit-title" value="{{ task.title }}">
        <label for="edit-desc">Description</label>
        <textarea name="description" id="edit-desc" rows="3">{{ task.description or '' }}</textarea>
        <div class="grid">
            <div>
                <label for="edit-priority">Priority</label>
                <select name="priority" id="edit-priority">
                    {% for p in ['low', 'medium', 'high', 'urgent'] %}
                    <option value="{{ p }}" {% if task.priority.value == p %}selected{% endif %}>{{ p|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="edit-status">Status</label>
                <select name="status" id="edit-status">
                    {% for s in ['todo', 'in_progress', 'done', 'cancelled'] %}
                    <option value="{{ s }}" {% if task.status.value == s %}selected{% endif %}>{{ s|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <label for="edit-due">Due Date</label>
        <input type="datetime-local" name="due_date" id="edit-due" value="{{ task.due_date.strftime('%Y-%m-%dT%H:%M') if task.due_date else '' }}">
        <button type="submit">Save</button>
    </form>
</details>
{% endblock %}
